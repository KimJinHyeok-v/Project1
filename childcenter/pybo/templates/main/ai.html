{# templates/main/ai.html #}
{% extends "base.html" %}
{% block body_class %}hero-page{% endblock %}

{% block extra_css %}
<link rel="stylesheet" href="{{ url_for('static', filename='css/ai2.css') }}">
<style>
  /* 1. 레이아웃 및 헤더 간섭 방지 */
  body.hero-page { background-color: #f1f5f9; padding-top: 0 !important; }
  
  .hero-section.hero-ai {
    position: relative; height: 180px !important;
    background: linear-gradient(135deg, #0f172a 0%, #1e293b 100%);
    display: flex; align-items: center; z-index: 5;
  }

  .ai-layout-wrap { 
    display: flex; gap: 20px; max-width: 1450px; 
    margin: 40px auto; padding: 0 20px; 
    align-items: flex-start; position: relative; z-index: 10;
  }

  /* 2. 왼쪽 채팅 박스 */
  .chat-box-main { 
    flex: 2; background: #1e293b; border: 1px solid #334155; 
    border-radius: 20px; padding: 25px; position: relative; 
    min-height: 800px; display: flex; flex-direction: column; overflow: hidden; 
  }

  /* 모델 선택 오버레이 및 카드 */
  #modelOverlay {
    position: absolute; top:0; left:0; width:100%; height:100%;
    background: rgba(15, 23, 42, 0.98); z-index: 110; border-radius: 20px;
    display: flex; flex-direction: column; align-items: center; justify-content: center;
  }
  .model-card-btn {
    background: #2d3748; border: 2px solid #4a5568; color: #cbd5e1;
    padding: 12px 24px; border-radius: 12px; cursor: pointer; transition: 0.3s;
  }
  .model-card-btn.active {
    background: #2563eb !important; border-color: #60a5fa !important; color: #fff !important;
    box-shadow: 0 0 10px rgba(37, 99, 235, 0.5);
  }

  /* 하단 입력바 (줄바꿈 방지) */
  .input-container-fixed { 
    display: flex; align-items: stretch; gap: 10px; 
    background: #0f172a; padding: 8px; border-radius: 12px; border: 1px solid #334155; 
  }
  .input-container-fixed input { flex: 1; background: transparent; border: none; color: white; padding: 10px; outline: none; }
  .btn-send-fixed { width: 80px; font-weight: bold; white-space: nowrap; flex-shrink: 0; }

  /* 3. 오른쪽 보고서 설정 및 시스템 상태 */
  .report-config-side { flex: 0.8; background: #1e293b; border: 1px solid #334155; border-radius: 20px; padding: 25px; color: #fff; position: sticky; top: 100px; }
  .status-text-soft { color: #d1d5db; font-size: 0.85rem; line-height: 1.6; }

  /* 4. 상세 설정 슬라이드 패널 */
  .parameter-slide-panel { 
    position: absolute; top: 0; right: -420px; width: 400px; height: 100%; 
    background: #1e293b; border-left: 1px solid #475569; z-index: 105; 
    padding: 25px; color: #fff; transition: right 0.3s ease; overflow-y: auto; 
  }
  .parameter-slide-panel.active { right: 0; }
  .val-blue { font-weight: 800; color: #60a5fa; }
</style>
{% endblock %}

{% block content %}
<section class="hero-section hero-ai">
  <div class="container"><h1 style="color:white; font-weight:800; margin:0; padding-left:20px;">생성형 AI 서비스</h1></div>
</section>

<div class="ai-layout-wrap">
  <div class="chat-box-main">
    <div id="modelOverlay">
      <h5 class="text-white mb-4">모델을 선택하세요</h5>
      <div class="d-flex gap-2 mb-4">
        <div class="model-card-btn" onclick="selectModel(this, 'base')">Base Model</div>
        <div class="model-card-btn" onclick="selectModel(this, 'cp50')">Checkpoint 50</div>
        <div class="model-card-btn" onclick="selectModel(this, 'cp100')">Checkpoint 100</div>
      </div>
      <button onclick="confirmStart()" class="btn btn-primary btn-lg px-5 font-weight-bold">채팅 시작</button>
    </div>

    <div class="d-flex justify-content-between align-items-center mb-3">
        <div>
            <span id="activeModelBadge" class="badge badge-primary p-2">모델 미선택</span>
            <button class="btn btn-sm btn-dark border-secondary ml-2" onclick="toggleParams()">⚙️ 파라미터 설정</button>
        </div>
        <div class="d-flex align-items-center">
            <span id="geoDot" style="width:12px; height:12px; background:#666; border-radius:50%; display:inline-block; margin-right:8px;"></span>
            <span id="geoText" class="text-white-50 small">위치 확인 대기</span>
        </div>
    </div>

    <div id="chatLog" style="flex:1; background:#0f172a; border-radius:15px; margin-bottom:15px; overflow-y:auto; padding:20px;">
        <div class="ai2-msg ai2-msg--bot"><div class="ai2-bubble">반갑습니다! 무엇을 도와드릴까요?</div></div>
    </div>

    <div class="input-container-fixed">
      <input id="chatInput" type="text" placeholder="메시지를 입력하세요..." onkeydown="if(event.key==='Enter') sendChat()">
      <button class="btn btn-primary btn-send-fixed" onclick="sendChat()">전송</button>
    </div>

    <div id="paramPanel" class="parameter-slide-panel">
        <div class="d-flex justify-content-between align-items-center mb-4">
            <h5 class="m-0 text-info">상세 설정</h5>
            <button class="btn btn-sm btn-outline-light" onclick="toggleParams()">닫기</button>
        </div>
        <div class="row mb-3">
            <div class="col-6">
                <label class="small text-white-50">창의성 (Temp): <span id="tVal" class="val-blue">0.7</span></label>
                <input type="range" id="p_temp" class="custom-range" min="0.1" max="1.0" step="0.1" value="0.7" oninput="document.getElementById('tVal').innerText=this.value">
            </div>
            <div class="col-6">
                <label class="small text-white-50">반복 억제: <span id="rpVal" class="val-blue">1.1</span></label>
                <input type="range" id="p_rep" class="custom-range" min="1.0" max="2.0" step="0.1" value="1.1" oninput="document.getElementById('rpVal').innerText=this.value">
            </div>
        </div>
        <div class="mb-4">
            <label class="small text-white-50">최대 답변 길이: <span id="tkVal" class="val-blue">512</span></label>
            <input type="range" id="p_max_tk" class="custom-range w-100" min="128" max="1024" step="128" value="512" oninput="document.getElementById('tkVal').innerText=this.value">
        </div>
        <hr class="border-secondary">
        <div class="mb-3">
            <label class="small" style="color:#4ade80">학습률 (LR): <span id="lrVal" class="val-blue" style="color:#4ade80!important">0.0001</span></label>
            <input type="range" id="p_lr" class="custom-range w-100" min="0.00001" max="0.001" step="0.00001" value="0.0001" oninput="document.getElementById('lrVal').innerText=this.value">
        </div>
        <div class="row g-2 mb-3">
            <div class="col-6"><label class="small text-white-50">Max Steps</label><input type="number" id="p_max_s" class="form-control form-control-sm bg-dark text-white border-secondary" value="100"></div>
            <div class="col-6"><label class="small text-white-50">Logging Steps</label><input type="number" id="p_log_s" class="form-control form-control-sm bg-dark text-white border-secondary" value="1"></div>
        </div>
        <div class="row g-2 mb-4">
            <div class="col-6"><label class="small text-white-50">Save Steps</label><input type="number" id="p_save_s" class="form-control form-control-sm bg-dark text-white border-secondary" value="50"></div>
            <div class="col-6"><label class="small text-white-50">Eval Steps</label><input type="number" id="p_eval_s" class="form-control form-control-sm bg-dark text-white border-secondary" value="10"></div>
        </div>
        <div class="row g-2 mb-4">
            <div class="col-6"><label class="small text-white-50">Optimizer</label><select class="form-control form-control-sm bg-dark text-white border-secondary"><option>adamw_8bit</option><option>adamw_torch</option></select></div>
            <div class="col-6"><label class="small text-white-50">Eval Strategy</label><div class="small mt-1"><label class="mr-2"><input type="radio" name="ev" checked> steps</label><label><input type="radio" name="ev"> epoch</label></div></div>
        </div>
        <button class="btn btn-info w-100 font-weight-bold py-2 mb-3" onclick="applySettings()">설정 적용하기</button>
    </div>
  </div>

  <!-- <div class="report-config-side">
    <h5 class="mb-4" style="color:#4ade80">보고서 초안 생성</h5>
    <div class="mb-3">
        <label class="small text-white-50">자치구 선택</label>
        <select id="dist" class="form-control bg-dark text-white border-secondary">
            <option value="" disabled selected>자치구 선택</option>
            <option>강남구</option><option>강동구</option><option>강북구</option><option>강서구</option>
            <option>관악구</option><option>광진구</option><option>구로구</option><option>금천구</option>
            <option>노원구</option><option>도봉구</option><option>동대문구</option><option>동작구</option>
            <option>마포구</option><option>서대문구</option><option>서초구</option><option>성동구</option>
            <option>성북구</option><option>송파구</option><option>양천구</option><option>영등포구</option>
            <option>용산구</option><option>은평구</option><option>종로구</option><option>중구</option><option>중랑구</option>
        </select>
    </div>
    <div class="row mb-4">
        <div class="col-6"><label class="small text-white-50">시작연도</label><select id="yf" class="form-control bg-dark text-white border-secondary" onchange="sync()"></select></div>
        <div class="col-6"><label class="small text-white-50">종료연도</label><select id="yt" class="form-control bg-dark text-white border-secondary" onchange="sync()"></select></div>
    </div>
    <button class="btn btn-success w-100 font-weight-bold py-2 mb-4" onclick="genRep()">보고서 초안 생성</button>
    
    <div class="status-text-soft">
        <div class="mb-2">● 위치 서비스: <b style="color:#4ade80">정상 (ON)</b></div>
        <div class="mb-2">● 엔진: Llama-3-8B</div>
    </div>
  </div> -->
</div>

<script>
let curM = null, uLat = null, uLon = null;

function toggleParams() { document.getElementById('paramPanel').classList.toggle('active'); }

function selectModel(btn, id) {
    document.querySelectorAll('.model-card-btn').forEach(b => b.classList.remove('active'));
    btn.classList.add('active');
    curM = id;
}

function confirmStart() {
    if(!curM) return alert("모델을 선택하세요.");
    document.getElementById('activeModelBadge').innerText = "Active: " + curM.toUpperCase();
    document.getElementById('modelOverlay').style.display = 'none';
    initGeo(); initY();
}

function initY() {
    const f = document.getElementById('yf'), t = document.getElementById('yt');
    if(f.options.length > 0) return;
    for(let i=2023; i<=2030; i++) { f.add(new Option(i, i)); t.add(new Option(i, i)); }
    t.value = 2030;
}

function sync() {
    const f = document.getElementById('yf'), t = document.getElementById('yt');
    if (parseInt(f.value) > parseInt(t.value)) t.value = f.value;
}

function initGeo() {
    if (navigator.geolocation) {
        navigator.geolocation.getCurrentPosition(pos => {
            uLat = pos.coords.latitude; uLon = pos.coords.longitude;
            const dot = document.getElementById('geoDot');
            dot.style.backgroundColor = '#4ade80'; dot.style.boxShadow = '0 0 10px #4ade80';
            document.getElementById('geoText').innerText = "위치 확인됨";
            document.getElementById('geoText').style.color = "#4ade80";
        });
    }
}

function applySettings() {
    alert("파라미터 설정이 모델에 적용되었습니다.");
    toggleParams();
}

async function sendChat() {
    const inp = document.getElementById('chatInput');
    const msg = inp.value.trim();
    if(!msg || !curM) return;
    appendMsg('user', msg); inp.value = '';
    try {
        const res = await fetch("/ai2/chat", {
            method: "POST", headers: {"Content-Type": "application/json"},
            body: JSON.stringify({ 
                message: msg, model_type: curM, lat: uLat, lon: uLon,
                temp: document.getElementById('p_temp').value
            })
        });
        const data = await res.json();
        appendMsg('bot', data.text);
    } catch(e) { appendMsg('bot', "B2C 서버 응답 오류"); }
}

async function genRep() {
    const d = document.getElementById('dist').value;
    const y1 = document.getElementById('yf').value, y2 = document.getElementById('yt').value;
    if(!d) return alert("자치구를 선택하세요.");
    appendMsg('user', `${d} (${y1}~${y2}) 보고서 생성을 시작합니다.`);
    try {
        const res = await fetch("/ai2/b2b/report/generate", {
            method: "POST", headers: {"Content-Type": "application/json"},
            body: JSON.stringify({ district: d, year_from: y1, year_to: y2, report_type: "approval" })
        });
        const data = await res.json();
        appendMsg('bot', data.report || "생성 실패");
    } catch(e) { appendMsg('bot', "통신 에러"); }
}

function appendMsg(sender, text) {
    const log = document.getElementById('chatLog');
    const div = document.createElement('div');
    div.className = sender === 'user' ? 'ai2-msg ai2-msg--user' : 'ai2-msg ai2-msg--bot';
    div.innerHTML = `<div class="ai2-bubble" style="white-space:pre-wrap;">${text}</div>`;
    log.appendChild(div); log.scrollTop = log.scrollHeight;
}
</script>
{% endblock %}