{# templates/ai/index.html #}
{% extends "base.html" %}
{% block body_class %}hero-page{% endblock %}

{% block extra_css %}
<link rel="stylesheet" href="{{ url_for('static', filename='css/ai.css') }}">
{% endblock %}


{% block content %}
<section class="hero-section hero-ai">
    <div class="hero-overlay"></div>
    <div class="container hero-inner">
        <h1 class="hero-title">생성형 AI</h1>
    </div>
</section>

<div class = 'container mt-4'>
    <p class = 'text-muted mb-4'> 
        ...내용 블라블라 ...<br>
    </p>

    <ul class="nav nav-tabs mb-4" id="aiFunctionTab" role ='tablist'>
        <li class="nav-item" role="presentation">
            <a class="nav-link active" id="gen-tab" data-toggle="tab" href="#gen" type="button" role="tab" aria-controls="gen" aria-selected="true">
                1. 텍스트 생성
            </a>
        </li>
        <li class = 'nav-item' role="presentation">
            <a class="nav-link" id="trans-tab" data-toggle="tab" href="#trans" type="button" role="tab" aria-controls="trans" aria-selected="false">
                2. 번역기
            </a>
        </li>
        <li class='nav-item' role="presentation">
            <a class="nav-link" id="ner-tab" data-toggle="tab" href="#ner" type="button" role="tab" aria-controls="ner" aria-selected="false">
                3. 개체명 인식
            </a>
        </li>
        <li class='nav-item' role="presentation">
            <a class="nav-link" id="qa-tab" data-toggle="tab" href="#qa" type="button" role="tab" aria-controls="qa" aria-selected="false">
                4. 질의응답
            </a>
        </li>
        <li class='nav-item' role="presentation">
            <a class="nav-link" id="sentiment-tab" data-toggle="tab" href="#sentiment" type="button" role="tab" aria-controls="sentiment" aria-selected="false">
                5. 감성분석
            </a>
        </li>
    </ul>

    <!-- 텍스트생성 -->
    <div class ='tab-content' id="aiFunctionTabContent">
        <div class="tab-pane fade show active" id="gen" role="tabpanel" aria-labelledby="gen-tab">
            <h4 class="mt-4 text-primary">텍스트 생성</h4>
            <div class="form-group">
                <label for="inputText" class="form-label">시작 문구 입력:</label>
                <textarea class="form-control" id="inputText" rows="4" 
                          placeholder="예: '오늘 철수는 친구와 즐겁게 놀았으며, 점심도 남김없이 다 먹었다. 선생님은...'" required></textarea>
            </div>
            
            <button class="btn btn-dark mt-3" onclick="generateText()">AI 생성 시작</button>
            
            <h5 class="mt-5">생성 결과:</h5>
            <div class="card p-4 bg-light">
                <p id="resultArea" class="mb-0 text-break">결과가 여기에 표시됩니다.</p>
            </div>
            
            <div id="loadingSpinner" class="spinner-border text-primary mt-3" role="status" style="display: none;">
                <span class="visually-hidden">Loading...</span>
            </div>
        </div>
        <!-- 번역 -->
        <div class="tab-pane fade" id="trans" role="tabpanel" aria-labelledby="trans-tab">
            <h4 class="mt-4 text-primary">번역 기능</h4>
            <div class="form-group">
                <label for="trans_inputText" class="form-label">번역할 한국어 텍스트:</label>                 <textarea class="form-control" id="trans_inputText" rows="4" 
                          placeholder="예: '오늘 급식은 아이들이 가장 좋아하는 카레가 나왔습니다.'" required></textarea>
            </div>
            
            <button class="btn btn-dark mt-3" onclick="handleTranslate()">AI 번역 시작</button>             
            <h5 class="mt-5">번역 결과 (영어):</h5>
            <div class="card p-4 bg-light">
                <p id="trans_resultArea" class="mb-0 text-break">번역 결과가 여기에 표시됩니다.</p>            </div>
            
            <div id="trans_loadingSpinner" class="spinner-border text-primary mt-3" role="status" style="display: none;">
                <span class="visually-hidden">Loading...</span>
            </div>
        </div>

        <!-- 개체명 인식 -->
        <div class="tab-pane fade" id="ner" role="tabpanel" aria-labelledby="ner-tab">
            <h4 class="mt-4 text-primary">개체명 인식 (NER)</h4>
            <div class="form-group">
                <label for="ner_inputText" class="form-label">분석할 텍스트:</label>
                <textarea class="form-control" id="ner_inputText" rows="4" 
                    placeholder="예: '김철수 선생님은 2025년 5월 15일에 서울특별시 교육청에서 연수를 받았습니다.'" required></textarea>
            </div>
            
            <button class="btn btn-dark mt-3" onclick="handleNER()">개체명 분석 시작</button>
            
            <h5 class="mt-5">인식 결과:</h5>
            <div class="card p-4 bg-light">
                <p id="ner_resultArea" class="mb-0 text-break">결과가 여기에 표시됩니다. (예: 김철수: 사람, 서울특별시: 장소, ...)</p>
            </div>
            
            <div id="ner_loadingSpinner" class="spinner-border text-primary mt-3" role="status" style="display: none;">
                <span class="visually-hidden">Loading...</span>
            </div>
        </div>

        <!-- 질의응답 -->
        <div class="tab-pane fade" id="qa" role="tabpanel" aria-labelledby="qa-tab">
            <h4 class="mt-4 text-primary">질의응답 (QA)</h4>
            <div class="form-group">
                <label for="qa_context" class="form-label">배경 텍스트 (지문):</label>
                <textarea class="form-control" id="qa_context" rows="4" 
                    placeholder="예: '지역아동센터의 여름 방학 프로그램은 7월 25일부터 8월 20일까지 운영되며, 주요 활동은 축구와 미술 수업입니다.'" required></textarea>
            </div>
            <div class="form-group mt-3">
                <label for="qa_question" class="form-label">질문:</label>
                <input type="text" class="form-control" id="qa_question" placeholder="예: 주요 활동은 무엇인가요?" required>
            </div>
            
            <button class="btn btn-dark mt-3" onclick="handleQA()">답변 요청</button>
            
            <h5 class="mt-5">답변:</h5>
            <div class="card p-4 bg-light">
                <p id="qa_resultArea" class="mb-0 text-break">답변이 여기에 표시됩니다.</p>
            </div>
            
            <div id="qa_loadingSpinner" class="spinner-border text-primary mt-3" role="status" style="display: none;">
                <span class="visually-hidden">Loading...</span>
            </div>
        </div>

        <!-- 감성분석 -->
        <div class="tab-pane fade" id="sentiment" role="tabpanel" aria-labelledby="sentiment-tab">
            <h4 class="mt-4 text-primary">감성분석</h4>
            <div class="form-group">
                <label for="sentiment_inputText" class="form-label">분석할 문장:</label>
                <textarea class="form-control" id="sentiment_inputText" rows="4" 
                    placeholder="예: '오늘 급식은 정말 맛있었고, 아이들이 모두 즐거워했습니다.'" required></textarea>
            </div>
            
            <button class="btn btn-dark mt-3" onclick="handleSentiment()">감성 분석 시작</button>
            
            <h5 class="mt-5">분석 결과:</h5>
            <div class="card p-4 bg-light">
                <p id="sentiment_resultArea" class="mb-0 text-break">결과가 여기에 표시됩니다. (예: 긍정)</p>
            </div>
            
            <div id="sentiment_loadingSpinner" class="spinner-border text-primary mt-3" role="status" style="display: none;">
                <span class="visually-hidden">Loading...</span>
            </div>
        </div>
    </div>


    <script>
    function generateText() {
        const inputText = document.getElementById('inputText').value;
        const resultArea = document.getElementById('resultArea');
        const loadingSpinner = document.getElementById('loadingSpinner');

        if (!inputText) {
            resultArea.innerHTML = '<span class="text-danger">시작 문구를 입력해 주세요.</span>';
            return;
        }

        // UI 업데이트: 로딩 상태 표시
        resultArea.innerHTML = 'AI가 문구를 생성 중입니다...';
        loadingSpinner.style.display = 'block'; 

        // ** /ai/api/generate-text 엔드포인트로 POST 요청 **
        fetch('{{ url_for("ai.api_generate_text") }}', { 
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            // 요청 본문에 입력 텍스트 포함
            body: JSON.stringify({ inputText: inputText }),
        })
        .then(response => {
            // HTTP 상태 코드에 따라 오류 처리
            if (!response.ok) {
                // 4xx, 5xx 에러인 경우 JSON 응답을 읽어 오류 메시지를 반환
                return response.json().then(errorData => {
                    throw new Error(errorData.error || `HTTP Error! status: ${response.status}`);
                });
            }
            return response.json();
        })
        .then(data => {
            // 성공 시 결과 표시
            loadingSpinner.style.display = 'none'; 
            resultArea.innerText = data.result; 
        })
        .catch(error => {
            // 네트워크 오류 또는 서버 응답 오류 처리
            loadingSpinner.style.display = 'none'; 
            console.error('Error:', error);
            resultArea.innerHTML = `<span class="text-danger">오류 발생: ${error.message || '네트워크 요청 실패'}</span>`;
        });
    }

    // ----------------------------------------------------
    // 번역

    function handleTranslate() {
        // 번역 탭의 고유 ID를 사용합니다.
        const inputText = document.getElementById('trans_inputText').value; 
        const resultArea = document.getElementById('trans_resultArea');
        const loadingSpinner = document.getElementById('trans_loadingSpinner');

        if (!inputText) {
            resultArea.innerHTML = '<span class="text-danger">번역할 텍스트를 입력해 주세요.</span>';
            return;
        }

        // UI 업데이트: 로딩 상태 표시
        resultArea.innerHTML = 'AI가 번역 중입니다... (Colab 연결 중)';
        loadingSpinner.style.display = 'block'; 

        // /ai/api/translate-text 엔드포인트로 POST 요청
        fetch('{{ url_for("ai.api_translate_text") }}', { 
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify({ inputText: inputText }),
        })
        .then(response => {
            if (!response.ok) {
                return response.json().then(errorData => {
                    throw new Error(errorData.error || `HTTP Error! status: ${response.status}`);
                });
            }
            return response.json();
        })
        .then(data => {
            // 성공 시 결과 표시
            loadingSpinner.style.display = 'none'; 
            resultArea.innerText = data.result; 
        })
        .catch(error => {
            // 오류 처리
            loadingSpinner.style.display = 'none'; 
            console.error('Translation Error:', error);
            resultArea.innerHTML = `<span class="text-danger">번역 오류 발생: ${error.message || '네트워크 요청 실패'}</span>`;
        });
    }
    // ----------------------------------------------------
    // 3. 개체명 인식 (NER)
    function handleNER() {
        const inputText = document.getElementById('ner_inputText').value.trim(); 
        const resultArea = document.getElementById('ner_resultArea');
        const loadingSpinner = document.getElementById('ner_loadingSpinner');

        if (!inputText) {
            resultArea.innerHTML = '<span class="text-danger">분석할 텍스트를 입력해 주세요.</span>';
            return;
        }

        resultArea.innerHTML = 'AI가 개체명을 인식 중입니다...';
        loadingSpinner.style.display = 'block'; 

        fetch('{{ url_for("ai.api_ner") }}', { 
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ inputText: inputText }),
        })
        .then(response => response.json().then(data => ({ ok: response.ok, data: data })))
        .then(({ ok, data }) => {
            loadingSpinner.style.display = 'none'; 
            if (ok) {
                resultArea.innerText = data.result; 
            } else {
                resultArea.innerHTML = `<span class="text-danger">오류 발생: ${data.error || '알 수 없는 서버 오류'}</span>`;
            }
        })
        .catch(error => {
            loadingSpinner.style.display = 'none'; 
            console.error('NER Error:', error);
            resultArea.innerHTML = `<span class="text-danger">네트워크 오류: ${error.message}</span>`;
        });
    }

    // ----------------------------------------------------
    // 4. 질의응답 (QA)
    function handleQA() {
        const context = document.getElementById('qa_context').value.trim();
        const question = document.getElementById('qa_question').value.trim();
        const resultArea = document.getElementById('qa_resultArea');
        const loadingSpinner = document.getElementById('qa_loadingSpinner');

        if (!context || !question) {
            resultArea.innerHTML = '<span class="text-danger">배경 텍스트와 질문을 모두 입력해 주세요.</span>';
            return;
        }

        resultArea.innerHTML = 'AI가 질문에 답변 중입니다...';
        loadingSpinner.style.display = 'block'; 

        fetch('{{ url_for("ai.api_qa") }}', { 
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ context: context, question: question }),
        })
        .then(response => response.json().then(data => ({ ok: response.ok, data: data })))
        .then(({ ok, data }) => {
            loadingSpinner.style.display = 'none'; 
            if (ok) {
                resultArea.innerText = data.result; 
            } else {
                resultArea.innerHTML = `<span class="text-danger">오류 발생: ${data.error || '알 수 없는 서버 오류'}</span>`;
            }
        })
        .catch(error => {
            loadingSpinner.style.display = 'none'; 
            console.error('QA Error:', error);
            resultArea.innerHTML = `<span class="text-danger">네트워크 오류: ${error.message}</span>`;
        });
    }

    // ----------------------------------------------------
    // 5. 감성분석 (Sentiment Analysis)
    function handleSentiment() {
        const inputText = document.getElementById('sentiment_inputText').value.trim(); 
        const resultArea = document.getElementById('sentiment_resultArea');
        const loadingSpinner = document.getElementById('sentiment_loadingSpinner');

        if (!inputText) {
            resultArea.innerHTML = '<span class="text-danger">분석할 텍스트를 입력해 주세요.</span>';
            return;
        }

        resultArea.innerHTML = 'AI가 감성을 분석 중입니다...';
        loadingSpinner.style.display = 'block'; 

        fetch('{{ url_for("ai.api_sentiment") }}', { 
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ inputText: inputText }),
        })
        .then(response => response.json().then(data => ({ ok: response.ok, data: data })))
        .then(({ ok, data }) => {
            loadingSpinner.style.display = 'none'; 
            if (ok) {
                resultArea.innerText = data.result; 
            } else {
                resultArea.innerHTML = `<span class="text-danger">오류 발생: ${data.error || '알 수 없는 서버 오류'}</span>`;
            }
        })
        .catch(error => {
            loadingSpinner.style.display = 'none'; 
            console.error('Sentiment Error:', error);
            resultArea.innerHTML = `<span class="text-danger">네트워크 오류: ${error.message}</span>`;
        });
    }
    // ----------------------------------------------------
    </script>
    {% endblock %}


    {% block extra_js %}
    
    {% endblock %}


